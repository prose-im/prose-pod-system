#!/usr/bin/env bash

##
# This file is part of prose-pod-system
#
# Copyright 2025–2026, Prose Foundation
# SPDX-License-Identifier: MPL-2.0
#
# Authors:
# - 2025–2026, Rémi Bardon <remi@remibardon.name>
##

set -e

: ${SELF:="$(basename $0)"}
: ${REPOSITORY_ROOT:="$(realpath "$(dirname "$0")"/..)"};

: ${SCRIPTS_DIR:="$(dirname $0)"}
: ${BASH_TOOLBOX:="${SCRIPTS_DIR:?}"/bash-toolbox}
for util in colors edo log yes-no; do
  source "${BASH_TOOLBOX:?}/${util:?}.sh"
done
source "${SCRIPTS_DIR:?}"/tools/find-replace-versions.sh

SERVICES=(app dashboard api server)

usage() {
cat <<EOF
$(format_title 'Syntax:')
  $(format_command "${SELF}") $(format_opt_arg latest) $(format_opt_arg SERVICE=X.Y.Z)...
    Where $(format_arg SERVICE) is one of: ${SERVICES[@]}
    and $(format_arg X.Y.Z) is the new version of said service.

$(format_title 'Usage:')
  Update to all the latest versions:
    $(format_command "${SELF:?}") $(format_arg latest)
  Update individual versions:
    $(format_command "${SELF:?}") $(format_opt_arg 'app=X.Y.Z') $(format_opt_arg 'dashboard=X.Y.Z') $(format_opt_arg 'api=X.Y.Z') $(format_opt_arg 'server=X.Y.Z')
  Update to all the latest versions except a few (last value takes precedence):
    $(format_command "${SELF:?}") $(format_arg latest) $(format_opt_arg 'app=X.Y.Z') $(format_opt_arg 'dashboard=X.Y.Z') $(format_opt_arg 'api=X.Y.Z') $(format_opt_arg 'server=X.Y.Z')

$(format_title 'Options:')
  $(format_subtitle 'Miscellaneous options:')
    $(format_flag --help)
      Explains what the command does and how to use it.
    $(format_flag --dry-run)
      Do a dry run (i.e. print what would be executed instead of running it).
    $(format_flag --debug)
      Log debug messages when running the script.
    $(format_flag --trace)
      Log tracing messages when running the script.
EOF
}
help() {
	usage
	exit 0
}

get_version_from_VERSION_file() {
	local repo="${1:?"Expected repository name"}" head="${2:-master}"
	edo xh GET -b "https://raw.githubusercontent.com/prose-im/${repo}/refs/heads/${head}/VERSION" \| sed 's/[[:space:]]*$//'
}
get_version_from_package_json() {
	local repo="${1:?"Expected repository name"}" head="${2:-master}"
	edo xh GET -b "https://raw.githubusercontent.com/prose-im/${repo}/refs/heads/${head}/package.json" \| jq -r '.version'
}
get_latest_version() {
	local component="${1:?"Expected a Prose Pod component name"}"

	case $component in
		app) get_version_from_package_json prose-app-web ;;
		dashboard) get_version_from_package_json prose-pod-dashboard ;;
		api) get_version_from_VERSION_file prose-pod-api ;;
		server) get_version_from_VERSION_file prose-pod-server ;;
		*) die 'Unknown component: `'"$component"'`.' ;;
	esac
}

if [ $# -eq 0 ]; then
	info 'No version provided, updating to latest versions…'
	set -- latest
fi

for arg in "$@"; do
	case $arg in
		latest)
			NEW_APP_TAG="$(get_latest_version app)"
			NEW_DASHBOARD_TAG="$(get_latest_version dashboard)"
			NEW_API_TAG="$(get_latest_version api)"
			NEW_SERVER_TAG="$(get_latest_version server)"
			;;
		app=*) NEW_APP_TAG="${arg#'app='}" ;;
		dashboard=*) NEW_DASHBOARD_TAG="${arg#'dashboard='}" ;;
		api=*) NEW_API_TAG="${arg#'api='}" ;;
		server=*) NEW_SERVER_TAG="${arg#'server='}" ;;
		--help) help ;;
		--dry-run) export DRY_RUN=1 ;;
		--debug) export LOG_LEVEL=debug ;;
		--trace) export LOG_LEVEL=trace ;;
		*) error 'Unknown argument: `'"$arg"'`.'; info "$(usage)"; die ;;
	esac
done

OLD_APP_TAG="$(find_version_app)"
if [[ -n "${NEW_APP_TAG}" ]] && [[ "${NEW_APP_TAG}" != "${OLD_APP_TAG:?}" ]]; then
	info "App: $(fg_yellow "${OLD_APP_TAG:?}") -> $(fg_green "${NEW_APP_TAG:?}")"
else
	info "App: $(fg_cyan "${OLD_APP_TAG:?}")"
fi

OLD_DASHBOARD_TAG="$(find_version_dashboard)"
if [[ -n "${NEW_DASHBOARD_TAG}" ]] && [[ "${NEW_DASHBOARD_TAG}" != "${OLD_DASHBOARD_TAG:?}" ]]; then
	info "Dashboard: $(fg_yellow "${OLD_DASHBOARD_TAG:?}") -> $(fg_green "${NEW_DASHBOARD_TAG:?}")"
else
	info "Dashboard: $(fg_cyan "${OLD_DASHBOARD_TAG:?}")"
fi

OLD_API_TAG="$(find_version_api)"
if [[ -n "${NEW_API_TAG}" ]] && [[ "${NEW_API_TAG}" != "${OLD_API_TAG:?}" ]]; then
	info "API: $(fg_yellow "${OLD_API_TAG:?}") -> $(fg_green "${NEW_API_TAG:?}")"
else
	info "API: $(fg_cyan "${OLD_API_TAG:?}")"
fi

OLD_SERVER_TAG="$(find_version_server)"
if [[ -n "${NEW_SERVER_TAG}" ]] && [[ "${NEW_SERVER_TAG}" != "${OLD_SERVER_TAG:?}" ]]; then
	info "Server: $(fg_yellow "${OLD_SERVER_TAG:?}") -> $(fg_green "${NEW_SERVER_TAG:?}")"
else
	info "Server: $(fg_cyan "${OLD_SERVER_TAG:?}")"
fi

ask_yes_no 'Proceed?' n || exit 1

if [[ -n "${NEW_APP_TAG}" ]]; then
	replace_version_app "${NEW_APP_TAG:?}"
fi
if [[ -n "${NEW_DASHBOARD_TAG}" ]]; then
	replace_version_dashboard "${NEW_DASHBOARD_TAG:?}"
fi
if [[ -n "${NEW_API_TAG}" ]]; then
	replace_version_api "${NEW_API_TAG:?}"
fi
if [[ -n "${NEW_SERVER_TAG}" ]]; then
	replace_version_server "${NEW_SERVER_TAG:?}"
fi
